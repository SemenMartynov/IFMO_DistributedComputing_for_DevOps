#SPDX-License-Identifier: MIT-0
---
- name: Install packages
  ansible.builtin.apt:
    pkg:
      - mysql-server
      - mysql-client
      - python3-pip

- name: Install PyMySQL
  ansible.builtin.pip:
    name: PyMySQL

- name: Copy mysql.cnf
  ansible.builtin.template:
    src: mysql.cnf.j2
    dest: /etc/mysql/mysql.conf.d/mysqld.cnf

- name: Mysql restart
  ansible.builtin.systemd_service:
    name: mysql
    state: restarted

- name: Create superuser
  community.mysql.mysql_query:
    login_db: mysql
    query: CHANGE REPLICATION SOURCE TO SOURCE_HOST='{{ hostvars[groups['master'][0]]['ansible_ssh_host'] }}', SOURCE_USER='replica_user', SOURCE_PASSWORD='{{ password.stdout }}', SOURCE_LOG_FILE='{{ hostvars[groups['master'][0]]['binlog_name'].msg }}', SOURCE_LOG_POS={{ hostvars[groups['master'][0]]['binlog_state'].msg | int }};
    login_unix_socket: /run/mysqld/mysqld.sock
  ignore_errors: true

- name: Start replica
  community.mysql.mysql_query:
    login_db: mysql
    query: START REPLICA;
    login_unix_socket: /run/mysqld/mysqld.sock
