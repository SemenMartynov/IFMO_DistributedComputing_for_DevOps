- name: Home work 4
  hosts: carrier
  become: true

  roles:
    - galera
    - haproxy

  tasks:
    - name: Update WordPress settings to work via HAProxy
      ansible.builtin.set_fact:
        db_master: "haproxy"
        db_host: "haproxy"

    - name: Include variables from defaults
      ansible.builtin.include_vars:
        file: roles/wordpress/defaults/main.yml

    - name: Regenerate WordPress docker-compose with new DB host
      ansible.builtin.template:
        src: roles/wordpress/templates/docker-compose.yml.j2
        dest: "{{ wordpress_install_dir }}/docker-compose.yml"
        mode: '0644'

    - name: Restart WordPress services
      community.docker.docker_compose_v2:
        project_src: "{{ wordpress_install_dir }}"
        state: present
        recreate: auto
