- name: Извлечь координаты репликации из дампа
  shell: |
    docker exec {{ master_container_name }} \
    grep -m 1 'CHANGE MASTER TO' {{ dump_path }} | sed -E "s/^--[[:space:]]*//; s/^CHANGE MASTER TO[[:space:]]*//"
  register: change_master_cmd
  changed_when: false

- name: Остановить slave если запущен
  shell: |
    docker exec {{ slave_container_name }} \
    mysql -u{{ mysql_root_user }} -p{{ mysql_root_password }} -e "STOP SLAVE;"
  ignore_errors: true

- name: Сформировать полную команду CHANGE MASTER TO
  set_fact:
    full_change_master_cmd: >
      CHANGE MASTER TO
      MASTER_HOST='{{ mysql_master_host }}',
      MASTER_USER='{{ mysql_replication_user }}',
      MASTER_PASSWORD='{{ mysql_replication_password }}',
      {{ change_master_cmd.stdout | trim | regex_replace(';$', '') }};

- name: Настроить CHANGE_MASTER_TO
  shell: |
    docker exec {{ slave_container_name }} \
    mysql -u{{ mysql_root_user }} -p{{ mysql_root_password }} -e "{{ full_change_master_cmd }}"
  when: change_master_cmd.stdout != ""

- name: Запуск репликации на slave
  shell: |
    docker exec {{ slave_container_name }} \
    mysql -u{{ mysql_root_user }} -p{{ mysql_root_password }} -e "START REPLICA;"

- name: Проверить replica статус
  shell: |
    docker exec {{ slave_container_name }} \
    mysql -u{{ mysql_root_user }} -p{{ mysql_root_password }} -e "SHOW REPLICA STATUS\G"
  register: slave_status
  changed_when: false

- name: Напечатать replica status
  debug:
    var: slave_status