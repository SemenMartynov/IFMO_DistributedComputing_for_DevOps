- name: Configure MariaDB as master in Docker container
  tags: create_master
  block:

  - name: Ensure mariadb.cnf
    stat:
      path: "{{ vol_db_conf }}/mariadb.cnf"
    register: mycnf_status

  - name: Fail if mariadb.cnf does not exist
    fail:
      msg: "{{ vol_db_conf }}/mariadb.cnf does not exist"
    when: not mycnf_status.stat.exists

  - name: Create backup MariaDB my.cnf to host machine
    command: "cp {{ vol_db_conf }}/mariadb.cnf {{ vol_db_conf }}/mariadb.cnf.backup"

  - name: Ensure [mysqld] section is present in mariadb.cnf
    lineinfile:
      path: "{{ vol_db_conf }}/mariadb.cnf"
      regexp: "^\\[mysqld\\]"
      line: "[mysqld]"
      insertbefore: "^# Import all .cnf files from configuration directory"

  - name: Ensure replication parameters are in my.cnf
    lineinfile:
      path: "{{ vol_db_conf }}/mariadb.cnf"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      insertafter: "[mysqld]"
    with_items:
      - { regexp: '^server-id=', line: 'server-id=1' }
      - { regexp: '^log-bin=', line: 'log-bin=/var/lib/mysql/mysql-bin.log' }
      - { regexp: '^binlog-ignore-db=', line: 'binlog-ignore-db=information_schema' }
      - { regexp: '^binlog-format=', line: 'binlog-format=ROW' }
      - { regexp: '^bind-address=', line: 'bind-address=0.0.0.0' }
      - { regexp: '^default_authentication_plugin=', line: 'default_authentication_plugin=mysql_native_password' }

  - name: Restart MariaDB in the Docker container
    community.docker.docker_container:
      name: db
      state: started
      restart: true

  - name: Wait for MySQL to be ready
    community.docker.docker_container_exec:
      container: db
      command: healthcheck.sh --connect --innodb_initialized
    register: mysql_ready
    retries: 10
    delay: 5
    until: mysql_ready.rc == 0

  - name: Verify the master configuration inside Docker container
    community.docker.docker_container_exec:
      container: db
      command: bash -c "mariadb -u root -p{{ db_root_password }} -e 'SHOW BINLOG STATUS;'"
    register: master_status
    failed_when: master_status.rc != 0

  - name: Debug replication master status
    debug:
      var: master_status.stdout_lines

  - name: Log success message
    debug:
      msg: "MariaDB replication parameters successfully updated!"

  rescue:
    - name: Log error during MariaDB master configuration
      debug:
        msg: "MariaDB configuration failed, restoring original config."

    - name: Restore original MariaDB my.cnf from backup
      command: "cp {{ vol_db_conf }}/mariadb.cnf.backup {{ vol_db_conf }}/mariadb.cnf"

    - name: Restart MariaDB with original configuration
      community.docker.docker_container:
        name: db
        state: started
        restart: true

    - name: Log successful restoration
      debug:
        msg: "MariaDB configuration inside the Docker container was restored from backup."