---
- name: Ensure monitoring directory exists
  file:
    path: "{{ monitoring_dir }}"
    state: directory

- name: Copy docker-compose template
  template:
    src: docker-compose.yml.j2
    dest: "{{ monitoring_dir }}/docker-compose.yml"

- name: Copy Prometheus config
  template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_dir }}/prometheus.yml"

- name: Copy .my.cnf for master exporter
  template:
    src: master.my.cnf.j2
    dest: "{{ monitoring_dir }}/master.my.cnf"

- name: Copy .my.cnf for replica exporter
  template:
    src: replica.my.cnf.j2
    dest: "{{ monitoring_dir }}/replica.my.cnf"

- name: Copy Grafana dashboard
  copy:
    src: dashboard.json
    dest: "{{ monitoring_dir }}/dashboard.json"

- name: Copy Grafana dashboard config
  copy:
    src: dashboard.yml
    dest: "{{ monitoring_dir }}/dashboard.yml"

- name: Copy Grafana prometheus config
  copy:
    src: prometheus_grafana.yml
    dest: "{{ monitoring_dir }}/prometheus_grafana.yml"

- name: Start containers
  community.docker.docker_compose_v2:
    project_src: "{{ monitoring_dir }}"
    state: present
    recreate: auto
    pull: missing
  register: output