#jinja2: lstrip_blocks: True
services:
  galera-node1:
    container_name: galera-node1
    environment:
      MARIADB_DATABASE:  {{ wordpress_db_name }}
      MARIADB_USER: {{ db_user }}
      MARIADB_PASSWORD: {{ db_user_pass }}
      MARIADB_ROOT_PASSWORD: {{ db_pass }}
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: "yes"
      MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: "yes"
      MARIADB_GALERA_MARIABACKUP_PASSWORD: {{ db_mariabackup_pass }}
      MARIADB_GALERA_SST_METHOD: rsync
    healthcheck:
      interval: 10s
      retries: 20
      start_period: 1m
      test: ["CMD", "/healthcheck.sh"]
    image: bitnami/mariadb-galera:11.4.6
    restart: unless-stopped
    volumes:
      - ./healthcheck.sh:/healthcheck.sh:ro
      - galera-node1:/bitnami/mariadb

  {% for i in range(2, 6) %}
  galera-node{{ i }}:
    container_name: galera-node{{ i }}
    depends_on:
      galera-node1:
        condition: service_healthy
    environment:
      MARIADB_DATABASE:  {{ wordpress_db_name }}
      MARIADB_USER: {{ db_user }}
      MARIADB_PASSWORD: {{ db_user_pass }}
      MARIADB_ROOT_PASSWORD: {{ db_pass }}
      MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://galera-node1,galera-node2,galera-node3,galera-node4,galera-node5
      MARIADB_GALERA_MARIABACKUP_PASSWORD: {{ db_mariabackup_pass }}
      MARIADB_GALERA_SST_METHOD: rsync
    healthcheck:
      interval: 10s
      retries: 20
      start_period: 1m
      test: ["CMD", "/healthcheck.sh"]
    image: bitnami/mariadb-galera:11.4.6
    restart: unless-stopped
    volumes:
      - ./healthcheck.sh:/healthcheck.sh:ro
      - galera-node{{ i }}:/bitnami/mariadb

  {% endfor %}
  {% for i in range(1, 6) %}
  galera-node{{ i }}-exporter:
    command: --mysqld.address=galera-node{{ i }}:{{ db_port }} --mysqld.username=root:{{ db_pass }}
    image: prom/mysqld-exporter:v0.17.2
    restart: unless-stopped

  {% endfor %}
volumes:
  galera-node1:
  galera-node2:
  galera-node3:
  galera-node4:
  galera-node5:
