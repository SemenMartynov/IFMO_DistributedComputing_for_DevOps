---
- name: Playbook 2 - Configure Master-Slave Replication
  hosts: carrier
  become: true

  vars:
    wordpress_install_dir: /opt/wordpress

  tasks:
    - name: Start DB slave service
      community.docker.docker_compose_v2:
        project_src: "{{ wordpress_install_dir }}"
        services: ["{{ db_replica }}"]
        pull: missing
        recreate: never
        remove_orphans: true

    - name: Wait until master MySQL is ready
      ansible.builtin.wait_for:
        host: localhost
        port: 3306
        state: started
        delay: 5
        timeout: 120

    - name: Wait until slave MySQL is ready
      ansible.builtin.wait_for:
        host: localhost
        port: 3307
        state: started
        delay: 5
        timeout: 120

    - name: Get master binlog status
      community.mysql.mysql_query:
        login_host: localhost
        login_port: 3306
        login_user: root
        login_password: "{{ wordpress_db_root_password }}"
        query: "SHOW MASTER STATUS"
      register: master_status
      retries: 40
      delay: 10
      until: master_status is succeeded

    - name: Fail if binary logging is disabled on master
      ansible.builtin.fail:
        msg: "Binary logging is disabled on master; cannot configure replication."
      when: master_status.query_result | length == 0

    - name: Set replication coordinates
      ansible.builtin.set_fact:
        master_file: "{{ master_status.query_result[0][0]['File'] }}"
        master_pos: "{{ master_status.query_result[0][0]['Position'] | int }}"

    - name: Stop replica before re-config
      community.mysql.mysql_replication:
        mode: stopreplica
        login_host: localhost
        login_port: 3307
        login_user: root
        login_password: "{{ wordpress_db_root_password }}"
      register: stop_replica
      retries: 40
      delay: 10
      until: stop_replica is succeeded

    - name: Change master configuration on slave
      community.mysql.mysql_replication:
        mode: changeprimary
        login_host: localhost
        login_port: 3307
        login_user: root
        login_password: "{{ wordpress_db_root_password }}"
        primary_host: "{{ db_master }}"
        primary_user: replicator
        primary_password: "{{ wordpress_replication_password }}"
        primary_port: 3306
        primary_log_file: "{{ master_file }}"
        primary_log_pos: "{{ master_pos }}"
      register: repl_change
      notify: Start slave threads   # handler вызовется только при change

  handlers:
    - name: Start slave threads
      community.mysql.mysql_replication:
        mode: startreplica
        login_host: localhost
        login_port: 3307
        login_user: root
        login_password: "{{ wordpress_db_root_password }}"
