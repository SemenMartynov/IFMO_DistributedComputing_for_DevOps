- name: Развернуть стек мониторинга с Prometheus и Grafana
  hosts: remote
  become: true
  vars_files:
    - roles/wordpress/vars/main.yml
  pre_tasks:
    - name: Установить необходимые коллекции Ansible
      ansible.builtin.command:
        cmd: "ansible-galaxy collection install {{ item }}"
      with_items:
        - community.docker
        - community.mysql
      delegate_to: localhost
      become: false
      run_once: true
      changed_when: false

    - name: Проверить, развернут ли WordPress
      stat:
        path: "{{ wordpress_dir | default('/home/ubuntu/wordpress') }}/docker-compose.yml"
      register: wordpress_compose_file

    - name: Прервать выполнение, если WordPress не развернут
      fail:
        msg: "WordPress должен быть развернут перед мониторингом. Сначала запустите плейбук WordPress."
      when: not wordpress_compose_file.stat.exists

    - name: Проверить, запущены ли контейнеры WordPress
      ansible.builtin.shell:
        cmd: "docker ps -q --filter name=wordpress"
      register: wordpress_containers
      become: true
      changed_when: false

    - name: Прервать выполнение, если контейнеры WordPress не запущены
      fail:
        msg: "Контейнеры WordPress должны быть запущены перед мониторингом. Убедитесь, что WordPress работает."
      when: wordpress_containers.stdout == ""
  roles:
    - monitoring
