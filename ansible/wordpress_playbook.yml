- name: Deploy WordPress
  hosts: all
  become: true
  vars:
    docker_compose_path: "/opt/wordpress"
    wordpress_db_name: "wordpress"
    wordpress_db_user: "wp_user"
    wordpress_db_password: "wp_password"
    wordpress_db_root_password: "rootpassword"
    repl_user: "repl"
    repl_password: "replpass"
  tasks:
    - name: Install required packages
      apt:
        name:
          - docker.io
          - python3-pip
        state: present
        update_cache: true

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: true
        state: started

    - name: Create Docker Compose directory
      file:
        path: "{{ docker_compose_path }}"
        state: directory
        mode: '0755'

    - name: Copy Docker Compose file
      copy:
        src: docker-compose.yml
        dest: "{{ docker_compose_path }}/docker-compose.yml"
        mode: '0644'

    - name: Copy Nginx Config File
      copy:
        src: nginx.conf
        dest: "{{ docker_compose_path }}/nginx.conf"
        mode: '0644'

    - name: Copy master.conf
      copy:
        src: master.conf
        dest: "{{ docker_compose_path }}/master.conf"

    - name: Copy replica.conf
      copy:
        src: replica.conf
        dest: "{{ docker_compose_path }}/replica.conf"

    - name: Bring down containers (if running)
      community.docker.docker_compose_v2:
        project_src: "{{ docker_compose_path }}"
        state: absent

    - name: Bring up containers
      community.docker.docker_compose_v2:
        project_src: "{{ docker_compose_path }}"
        state: present

    - name: Wait for master to be ready
      community.docker.docker_container_exec:
        container: mysql_master
        command: "mysqladmin ping -u root -p{{ wordpress_db_root_password }}"
      register: result
      retries: 10
      delay: 5
      until: result.rc == 0
      changed_when: false

    - name: Create replication user inside mysql_master container
      community.docker.docker_container_exec:
        container: mysql_master
        argv:
          - mysql
          - -uroot
          - -p{{ wordpress_db_root_password }}
          - -e
          - >
            CREATE USER IF NOT EXISTS '{{ repl_user }}'@'%' IDENTIFIED BY '{{ repl_password }}';
            GRANT REPLICATION SLAVE ON *.* TO '{{ repl_user }}'@'%';
            FLUSH PRIVILEGES;
      register: create_replication_user_result
      failed_when: create_replication_user_result.rc != 0

    - name: Get master status
      community.docker.docker_container_exec:
        container: mysql_master
        command: mysql -u root -p{{ wordpress_db_root_password }} -e "SHOW MASTER STATUS;"
      register: master_status_output
      changed_when: false

    - name: Parse master log file
      set_fact:
        master_log_file: "{{ master_status_output.stdout | regex_search('File: (.*)', '\\1') }}"

    - name: Parse master log position
      set_fact:
        master_log_pos: "{{ master_status_output.stdout | regex_search('Position: (\\d+)', '\\1') | int }}"

    - name: Wait for replica to be ready
      community.docker.docker_container_exec:
        container: mysql_replica
        command: "mysqladmin ping -u root -p{{ wordpress_db_root_password }}"
      register: result
      retries: 10
      delay: 5
      until: result.rc == 0
      changed_when: false

    - name: Configure replication on replica
      community.docker.docker_container_exec:
        container: mysql_replica
        command: >
          mysql -u root -p{{ wordpress_db_root_password }} -e "
          STOP SLAVE;
          CHANGE MASTER TO
            MASTER_HOST='mysql_master',
            MASTER_USER='{{ repl_user }}',
            MASTER_PASSWORD='{{ repl_password }}',
            MASTER_LOG_FILE='{{ master_log_file }}',
            MASTER_LOG_POS={{ master_log_pos }},
            GET_MASTER_PUBLIC_KEY = 1;
          START SLAVE;"
      changed_when: true

    - name: Check slave status
      community.docker.docker_container_exec:
        container: mysql_replica
        command: "mysql -u root -p{{ wordpress_db_root_password }} -e 'SHOW SLAVE STATUS\\G'"
      register: slave_status_output
      changed_when: false
