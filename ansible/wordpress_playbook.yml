- name: Deploy WordPress
  hosts: all
  become: true
  vars:
    docker_compose_path: "/opt/wordpress"
    wordpress_db_name: "wordpress"
    wordpress_db_user: "wp_user"
    wordpress_db_password: "wp_password"
    wordpress_db_root_password: "rootpassword"
    repl_user: "repl"
    repl_password: "replpass"
  tasks:
    - name: Install required packages
      apt:
        name:
          - docker.io
          - python3-pip
        state: present
        update_cache: true

    - name: Install PyMySQL for MySQL module support (on localhost)
      pip:
        name: pymysql
        executable: pip3
      delegate_to: localhost

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: true
        state: started

    - name: Create Docker Compose directory
      file:
        path: "{{ docker_compose_path }}"
        state: directory
        mode: '0755'

    - name: Copy Docker Compose file
      copy:
        src: docker-compose.yml
        dest: "{{ docker_compose_path }}/docker-compose.yml"
        mode: '0644'

    - name: Copy Nginx Config File
      copy:
        src: nginx.conf
        dest: "{{ docker_compose_path }}/nginx.conf"
        mode: '0644'

    - name: Copy master.conf
      copy:
        src: master.conf
        dest: "{{ docker_compose_path }}/master.conf"

    - name: Copy replica.conf
      copy:
        src: replica.conf
        dest: "{{ docker_compose_path }}/replica.conf"

    - name: Bring down containers (if running)
      community.docker.docker_compose_v2:
        project_src: "{{ docker_compose_path }}"
        state: absent

    - name: Bring up containers
      community.docker.docker_compose_v2:
        project_src: "{{ docker_compose_path }}"
        state: present

    - name: Wait for master to be ready
      community.docker.docker_container_exec:
        container: mysql_master
        command: "mysqladmin ping -u root -p{{ wordpress_db_root_password }}"
      register: result
      retries: 10
      delay: 5
      until: result.rc == 0
      changed_when: false

    - name: Dump existing WordPress database from master
      community.docker.docker_container_exec:
        container: mysql_master
        command: "mysqldump -u root -p{{ wordpress_db_root_password }} {{ wordpress_db_name }}"
      register: dump_result
      changed_when: false
      failed_when: dump_result.rc != 0

    - name: Save dump to file
      copy:
        content: "{{ dump_result.stdout }}"
        dest: "{{ docker_compose_path }}/wordpress.sql"
        mode: '0644'

    - name: Copy dump file into mysql_master container using docker cp (on host)
      community.docker.docker_container_exec:
        container: mysql_master
        command: "cat /wordpress.sql | mysql -u root -p{{ wordpress_db_root_password }} {{ wordpress_db_name }}"
      changed_when: true

    - name: Create replication user on master
      community.mysql.mysql_user:
        login_user: root
        login_password: "{{ wordpress_db_root_password }}"
        name: "{{ repl_user }}"
        host: "%"
        password: "{{ repl_password }}"
        priv: '*.*:REPLICATION SLAVE'
        state: present
      delegate_to: localhost

    - name: Get master status
      community.docker.docker_container_exec:
        container: mysql_master
        command: mysql -u root -p{{ wordpress_db_root_password }} -e "SHOW MASTER STATUS\G"
      register: master_status_output
      changed_when: false

    - name: Parse master log file
      set_fact:
        master_log_file: "{{ master_status_output.stdout | regex_search('File: (.*)', '\\1') }}"

    - name: Parse master log position
      set_fact:
        master_log_pos: "{{ master_status_output.stdout | regex_search('Position: (\\d+)', '\\1') | int }}"

    - name: Wait for replica to be ready
      community.docker.docker_container_exec:
        container: mysql_replica
        command: "mysql -u root -p{{ wordpress_db_root_password }} -e 'SHOW SLAVE STATUS\\G'"
        register: slave_status_output
        changed_when: false
