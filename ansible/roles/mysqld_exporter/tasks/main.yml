---
- name: Создание пользователя для экспортера
  community.mysql.mysql_user:
    login_host: 127.0.0.1
    login_port: 3306
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: exporter
    host: localhost
    password: "{{ mysql_exporter_password }}"
    priv: "*.*:PROCESS, REPLICATION CLIENT"
    state: present
    append_privs: true
  when: inventory_hostname == 'mysql-master'

- name: Создание директории для настроек my.conf
  ansible.builtin.file:
    path: /etc/mysql_exporter
    state: directory
    mode: '0755'

- name: Копировать my.conf для экпортера
  ansible.builtin.template:
    src: .my.cnf.j2
    dest: /etc/mysql_exporter/.my.cnf

- name: Установка mysqld-exporters
  community.docker.docker_container:
    name: "{{ mysqld_exporters_name }}"
    image: "{{ mysqld_exporters_image }}"
    ports:
      - "9104:9104"
    command: "--config.my-cnf=/etc/mysql_exporter/.my.cnf"
    restart_policy: always
    recreate: true
    state: started
    volumes:
      /etc/mysql_exporter/.my.cnf:/etc/mysql_exporter/.my.cnf
