- name: Ensure PostgreSQL 17 is installed
  ansible.builtin.apt:
    name: postgresql-17
    state: present

- name: Create Directus user with admin rights
  become: true
  become_user: postgres
  become_method: ansible.builtin.sudo
  community.postgresql.postgresql_user:
    name: directus
    password: directus
    role_attr_flags: "SUPERUSER"
    state: present
    host: 127.0.0.1
    port: 5432
    login_user: postgres
    login_password: ""

- name: Create Directus database
  become: true
  become_user: postgres
  become_method: ansible.builtin.sudo
  community.postgresql.postgresql_db:
    name: directus
    owner: directus
    state: present
    host: 127.0.0.1
    port: 5432
    login_user: postgres
    login_password: ""

- name: Allow access from for directus from {{ directus_ip }}
  become: true
  become_user: root
  ansible.builtin.lineinfile:
    path: /etc/postgresql/17/main/pg_hba.conf
    line: 'host directus directus {{ directus_ip }}/32 md5'
    backup: true

- name: Reload PostgreSQL service
  become: true
  ansible.builtin.service:
    name: postgresql
    state: reloaded
