- name: Создать директорию для Grafana provisioning
  ansible.builtin.file:
    path: /opt/grafana/provisioning/datasources
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: true

- name: Создать datasource для Prometheus
  ansible.builtin.copy:
    dest: /opt/grafana/provisioning/datasources/prometheus.yml
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          isDefault: true
    owner: root
    group: root
    mode: "0644"

- name: Создать директорию для dashboard JSON
  ansible.builtin.file:
    path: /opt/grafana/dashboards
    state: directory
    owner: root
    group: root
    mode: "0755"

# Используем локальный файл вместо скачивания
- name: Скопировать JSON дашборда PostgreSQL
  ansible.builtin.copy:
    src: /home/denis/ITMO/DistributedComputing/IFMO_DistributedComputing_for_DevOps/ansible/roles/setup_grafana/files/postgres_dashboard.json  # Путь к вашему локальному файлу
    dest: /opt/grafana/dashboards/postgres_dashboard.json
    mode: "0644"

- name: Создать директорию для provisioning dashboards
  ansible.builtin.file:
    path: /opt/grafana/provisioning/dashboards
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: true

- name: Создать provisioning для dashboard
  ansible.builtin.copy:
    dest: /opt/grafana/provisioning/dashboards/dashboard.yml
    content: |
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards
    owner: root
    group: root
    mode: "0644"

- name: Запустить Grafana в Docker
  community.docker.docker_container:
    name: "grafana"
    image: "grafana/grafana-oss"
    state: started
    restart_policy: always
    networks:
      - name: monitoring_net
    ports:
      - "3000:3000"
    volumes:
      - "/opt/grafana/provisioning:/etc/grafana/provisioning:ro"
      - "/opt/grafana/dashboards:/var/lib/grafana/dashboards:ro"
    env:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
