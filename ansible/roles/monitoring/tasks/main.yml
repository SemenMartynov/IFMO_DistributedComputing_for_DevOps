- name: Создать каталог для мониторинга
  file:
    path: "{{ monitoring_dir }}"
    state: directory
    mode: '0755'
  become: true

- name: Создать каталоги для конфигурации Grafana
  file:
    path: "{{ monitoring_dir }}/grafana/{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "provisioning/dashboards"
    - "provisioning/datasources"
    - "dashboards"
  become: true

- name: Скопировать конфигурацию Prometheus
  template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_dir }}/prometheus.yml"
    mode: '0644'
  become: true

- name: Скопировать настройку источника данных Grafana для Prometheus
  template:
    src: grafana/provisioning/datasources/prometheus.yml.j2
    dest: "{{ monitoring_dir }}/grafana/provisioning/datasources/prometheus.yml"
    mode: '0644'
  become: true

- name: Скопировать настройку дашбордов Grafana
  template:
    src: grafana/provisioning/dashboards/dashboards.yml.j2
    dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/dashboards.yml"
    mode: '0644'
  become: true

- name: Скопировать дашборды Grafana
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  with_items:
    - { src: "templates/grafana/dashboards/system_metrics.json", dest: "{{ monitoring_dir }}/grafana/dashboards/system_metrics.json" }
  become: true

- name: Скопировать файл Docker Compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ monitoring_dir }}/docker-compose.yml"
    mode: '0644'
  become: true
  register: compose_template

- name: Создать пользователя MySQL для мониторинга
  community.mysql.mysql_user:
    login_host: "{{ monitoring_mysql_master_host }}"
    login_user: root
    login_password: "{{ wordpress_mysql_root_password }}"
    name: "{{ monitoring_mysql_user }}"
    password: "{{ monitoring_mysql_password }}"
    priv: '*.*:SELECT,PROCESS,REPLICATION CLIENT'
    state: present
  become: true
  ignore_errors: yes

- name: Запустить стек мониторинга
  community.docker.docker_compose_v2:
    project_src: "{{ monitoring_dir }}"
    state: present
  become: true
