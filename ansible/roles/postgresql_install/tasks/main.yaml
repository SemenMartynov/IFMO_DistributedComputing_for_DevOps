- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install dependencies for adding PostgreSQL repository
  ansible.builtin.apt:
    name:
      - wget
      - ca-certificates
      - curl
      - lsb-release
      - python3-psycopg2
      - acl
    state: present

- name: Ensure ACL is installed
  ansible.builtin.apt:
    name: acl
    state: present
  become: true

- name: Add the PostgreSQL 17 GPG key
  ansible.builtin.apt_key:
    url: "https://www.postgresql.org/media/keys/ACCC4CF8.asc"
    state: present

- name: Add PostgreSQL 17 APT repository
  ansible.builtin.apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release | lower }}-pgdg main"
    state: present
    filename: "pgdg"
    update_cache: true

- name: Install PostgreSQL 17
  ansible.builtin.apt:
    name: postgresql-17
    state: present

- name: Ensure PostgreSQL service is running
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: true

- name: Set ACL on temporary directory /var/tmp for user postgres
  ansible.posix.acl:
    path: /var/tmp
    entity: postgres
    etype: user
    permissions: rx
    state: present
  become: true

- name: Allow full access from 127.0.0.1/32 for all users
  become: true
  become_user: root
  ansible.builtin.lineinfile:
    path: /etc/postgresql/17/main/pg_hba.conf
    regexp: '^host\s+all\s+all\s+127.0.0.1/32\s+'
    line: 'host all all 127.0.0.1/32 trust'
    backup: true

- name: Restart PostgreSQL service
  become: true
  ansible.builtin.service:
    name: postgresql
    state: restarted

- name: Configure PostgreSQL to listen on all addresses
  community.postgresql.postgresql_alter_system:
    param: listen_addresses
    value: "*"
  become: true
  become_user: postgres

- name: Restart PostgreSQL service
  become: true
  ansible.builtin.service:
    name: postgresql
    state: restarted

- name: Create replication role
  become: true
  become_user: postgres
  community.postgresql.postgresql_user:
    name: replication
    password: replication
    role_attr_flags: REPLICATION
    state: present
