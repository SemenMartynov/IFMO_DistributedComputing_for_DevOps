- name: Создать Docker-сеть для мониторинга
  community.docker.docker_network:
    name: monitoring_net
    driver: bridge

- name: Убедиться, что директория для конфигов Prometheus существует
  ansible.builtin.file:
    path: "/opt/prometheus"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Создать prometheus.yml
  ansible.builtin.copy:
    dest: "/opt/prometheus/prometheus.yml"
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      scrape_configs:
        - job_name: 'postgres_exporter'
          static_configs:
            - targets: ['192.168.56.20:9187']
    owner: root
    group: root
    mode: '0644'

- name: Запустить Prometheus в Docker
  community.docker.docker_container:
    name: "prometheus"
    image: "prom/prometheus"
    state: started
    restart_policy: always
    networks:
      - name: monitoring_net
    ports:
      - "9090:9090"
    volumes:
      - "/opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
