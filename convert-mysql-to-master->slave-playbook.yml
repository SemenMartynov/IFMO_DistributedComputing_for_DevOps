---
- name: 'Playbook converts standalone mysql instance to master->slave replication'
  hosts: all
  become: true
  vars_files:
    - defaults/main.yml
  vars:
    dbslave_container_name: "{{ db_container_name }}slave"

  tasks:
    - name: Generate MySQL password
      ansible.builtin.set_fact: mysql_passwd="{{ pwd_alias }}"

    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true
        
    - name: Install packages required by Ansible modules
      apt:
        pkg: # https://docs.ansible.com/ansible/latest/collections/community/mysql/mysql_db_module.html#requirements
          - python3-pymysql
          - mysql-client
          # - mysqldump is part of mysql-client
        state: latest
        update_cache: true

    - name: Create MySQL container for SLAVE
      community.docker.docker_container:
        name: "{{ dbslave_container_name }}"
        image: "{{ db_container_image }}"
        command: --server-id=2 --gtid-mode=ON --enforce-gtid-consistency=ON --plugin-load-add='clone=mysql_clone.so'
        state: started
        restart: true
        restart_policy: always
        networks:
          - name: "{{ wp_int_network }}"
            ipv4_address: "10.16.1.4"
            aliases: "{{ dbslave_container_name }}"
        exposed_ports:
          - 3306
          - 33060
        volumes:
          - db2:/var/lib/mysql
        env:
          MYSQL_ROOT_PASSWORD: "{{ mysql_root_pw }}"
          MYSQL_ROOT_HOST: '%'
#          MYSQL_RANDOM_ROOT_PASSWORD: '1'
#          MYSQL_DATABASE: "{{ wp_dbname }}"
#          MYSQL_USER: "{{ wp_dbuser }}"
#          MYSQL_PASSWORD: "{{ mysql_passwd }}"

    - name: Pause for 15s to start SLAVE
      ansible.builtin.pause:
        seconds: 15

    - name: Stop WP container
      community.docker.docker_container:
        name: "{{ wp_container_name }}"
        state: stopped

    - name: Backup current WP databases
    # just for sake of safety    
      mysql_db:
        state: dump
        name: all
        target: "{{ wp_mysql_dump }}"
        login_host: "{{ db_container_name }}"
        login_port: 3306
        login_password: "{{ mysql_root_pw }}"

    - name: Create replication user on MASTER and SLAVE
      community.mysql.mysql_user:
        login_host: "{{ item }}"
        login_port: 3306
        login_password: "{{ mysql_root_pw }}"      
        name: replica_user
        host: '%'
        plugin_auth_string: "{{ mysql_root_pw }}"
        plugin: 'caching_sha2_password'
        priv: '*.*:BACKUP_ADMIN, CLONE_ADMIN, REPLICATION SLAVE'
        state: present
      loop:
        - "{{ db_container_name }}"
        - "{{ dbslave_container_name }}"
        
    - name: Prepare MASTER for Cloning
      community.mysql.mysql_query:
        login_db: mysql
        login_host: "{{ db_container_name }}"
        login_port: 3306
        login_password: "{{ mysql_root_pw }}"
        query:
          - SET PERSIST_ONLY server_id = 1
          - SET PERSIST_ONLY enforce_gtid_consistency = ON
          - SET PERSIST_ONLY gtid_mode = ON
          - INSTALL PLUGIN clone SONAME 'mysql_clone.so'

    - name: Restart MySQL MASTER container
      community.docker.docker_container:
        name: "{{ db_container_name }}"
        state: started
        restart: true

    - name: Pause for 15s to start MASTER
      ansible.builtin.pause:
        seconds: 15

    - name: Cloning DB from MASTER to SLAVE
      ignore_errors: true # mysql will restart and disconnect after clone completed
      community.mysql.mysql_query:
        login_db: mysql
        login_host: "{{ dbslave_container_name }}"
        login_port: 3306
        login_password: "{{ mysql_root_pw }}"
        query:
          - SET GLOBAL clone_valid_donor_list = '{{ db_container_name }}:3306'
          - CLONE INSTANCE FROM 'replica_user'@'{{ db_container_name }}':3306 IDENTIFIED BY '{{ mysql_root_pw }}'

    - name: Pause for 15s to wait SLAVE restarting after CLONE
      ansible.builtin.pause:
        seconds: 15
        
    - name: Set and Start replication on SLAVE
      community.mysql.mysql_replication:
        login_host: "{{ dbslave_container_name }}"
        login_port: 3306      
        login_password: "{{ mysql_root_pw }}"
        mode: "{{ item }}"
        channel: "db1s"
        primary_auto_position: true
        primary_host: "{{ db_container_name }}"
        primary_port: 3306
        primary_user: "replica_user"
        primary_password: "{{ mysql_root_pw }}"
      loop:
        - changereplication
        - startreplica

    - name: Start WP container
      community.docker.docker_container:
        name: "{{ wp_container_name }}"
        state: started
