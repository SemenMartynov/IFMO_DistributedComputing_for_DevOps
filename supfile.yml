version: 0.4

env:
  GIT_REMOTE: https://github.com/idbolshakov-study/IFMO_DistributedComputing_for_DevOps
  ENVFILE_PATH: /opt/app/.env
  USER: idbolshakov
  APP_DIR: /opt/app
  CODE_DIR: /opt/app/code
  STORAGE_DIR: /opt/app/storage


networks:
  # this setup is used for run app in the local machine
  local:
    hosts:
      - localhost
  # this setup is used for run app in the remote machine
  remote:
    hosts:
      - 192.168.88.252
  # this setup is used for development purposes
  develop:
    env:
      CODE_DIR: .
    hosts:
      - localhost
        
commands:
  start:
    desc: Start wordpress instance in background
    run: cd $CODE_DIR && docker compose --env-file $ENVFILE_PATH up

  stop:
    desc: Stop wordpress instance
    run: cd $CODE_DIR && docker compose --env-file $ENVFILE_PATH down

  build:
    desc: Build wordpress instance containers
    run: cd $CODE_DIR && docker compose --env-file $ENVFILE_PATH build

  pull:
    desc: fetch from remote git repo to local branch
    run: cd $CODE_DIR && git pull;

  provision:
    desc: Setup project in a new environment
    run: >
      sudo mkdir -p $CODE_DIR &&
      sudo mkdir -p $STORAGE_DIR &&
      sudo chown -R $USER $APP_DIR && 
      cd $CODE_DIR && 
      git clone $GIT_REMOTE . ;

  ubuntu-prepare:
    desc: Setup ubuntu machine
    run: >
      # docker install
      sudo apt-get update
      sudo apt-get install ca-certificates curl
      sudo install -m 0755 -d /etc/apt/keyrings
      sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      sudo chmod a+r /etc/apt/keyrings/docker.asc
      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
           $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
           sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      sudo apt-get update;
      sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  monitoring-start:
    desc: start app monitoring
    run: >
      sudo docker run \
        --volume=/:/rootfs:ro \
        --volume=/var/run/docker.sock:/var/run/docker.sock:rw \
        --volume=/sys:/sys:ro \
        --volume=/var/lib/docker/:/var/lib/docker:ro \
        --volume=/dev/disk/:/dev/disk:ro \
        --publish=8070:8080 \
        --detach=true \
        --name=cadvisor \
        --privileged \
        --device=/dev/kmsg \
        gcr.io/cadvisor/cadvisor:v0.52.1

  monitoring-stop:
    desc: stop app monitoring
    run: >
      sudo docker stop cadvisor || true;
      sudo docker rm cadvisor || true;

targets:
  deploy:
    - pull
    - build
    - stop
    - start
