- name: Create haproxy_check user
  community.mysql.mysql_user:
    name: haproxy_check
    password: ""
    host: "%"
    priv: "mysql.*:USAGE"
    login_user: "{{ db_root_user }}"
    login_password: "{{ db_root_password }}"
    login_host: "{{ mariadb_bootstrap_ip }}"
    state: present

- name: Create HAProxy config directory
  ansible.builtin.file:
    path: "{{ haproxy_config_path }}"
    state: directory
    mode: '0644'

- name: Copy HAProxy configuration
  ansible.builtin.template:
    src: "haproxy.cfg.j2"
    dest: "{{ haproxy_config_path }}/haproxy.cfg"
    mode: '0644'

- name: Start HAProxy container
  community.docker.docker_container:
    name: haproxy
    image: haproxy:latest
    restart_policy: unless-stopped
    networks:
      - name: "{{ network }}"
    expose:
      - "{{ db_port }}"
    published_ports:
      - "8404:8404"
    volumes:
      - "{{ haproxy_config_path }}/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg"
    state: started

- name: WordPress container start
  community.docker.docker_container:
    name: wordpress
    state: started
    networks:
      - name: "{{ network }}"
    env:
      WORDPRESS_DB_HOST: haproxy:"{{ db_port }}"
      WORDPRESS_DB_NAME: "{{ db_name }}"
      WORDPRESS_DB_USER: "{{ db_user }}"
      WORDPRESS_DB_PASSWORD: "{{ db_password }}"
    ports:
      - "80:80"
    links:
      - haproxy
