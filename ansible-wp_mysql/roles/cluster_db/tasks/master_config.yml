- name: WordPress container stop
  docker_container:
    name: wordpress
    state: stopped

- name: pip install
  ansible.builtin.package:
    name: python3-pip
    state: present

- name: PyMySQL install
  ansible.builtin.pip:
    name: PyMySQL
    executable: pip3
    extra_args: --break-system-packages

- name: MysSQL client install
  ansible.builtin.package:
    name: default-mysql-client
    state: present

- name: Dump WordPress DB
  community.mysql.mysql_db:
    login_host: "{{ db_host }}"
    login_port: "{{ db_master_port }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"
    name: "{{ db_name }}"
    state: dump
    target: "{{ db_dump_path }}"
    dump_extra_args: --set-gtid-purged=OFF

- name: Drop WordPress DB
  community.mysql.mysql_db:
    login_user: root
    login_password: mysql_root_password
    name: "{{ db_name }}"
    state: absent

- name: Create WordPress DB
  community.mysql.mysql_db:
    login_user: root
    login_password: mysql_root_password
    name: "{{ db_name }}"
    state: present

- name: Create replica user
  community.mysql.mysql_user:
    login_user: root
    login_password: mysql_root_password
    name: replica
    host: "%"
    password: replica_pass
    priv: "*.*:REPLICATION SLAVE"
    state: present
