- name: Create slave volume
  docker_volume:
    name: mysql_slave_data

- name: MySQL slave container start
  docker_container:
    name: mysql_slave
    image: mysql:5.7
    state: started
    restart_policy: always
    networks:
      - name: wp-network
    env:
      MYSQL_ROOT_PASSWORD: rootpassword
    ports:
      "3307:3306"
    volumes:
      - mysql_slave_data:/var/lib/mysql2
    command:
      --server-id=2
      --log-bin=mysql-bin
      --relay-log=relay-log
      --gtid-mode=ON
      --enforce-gtid-consistency=TRUE
      --skip-host-cache
      --skip-name-resolve
  register: slave_container

- name: Wait for slave up
  wait_for:
    host: 127.0.0.1
    port: 3307
    delay: 10
    timeout: 60

- name: Configure slave
  shell: |
    docker exec mysql_slave mysql -uroot -prootpassword -e "
    STOP SLAVE;
    CHANGE MASTER TO
      MASTER_HOST='mysql',
      MASTER_USER='replica',
      MASTER_PASSWORD='replica_pass';
    START SLAVE;
    "
