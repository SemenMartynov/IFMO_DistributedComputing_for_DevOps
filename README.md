# Ansible Playbook –¥–ª—è WordPress

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã WordPress —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º PostgreSQL, –æ–±—Ä–∞—Ç–Ω—ã–º –ø—Ä–æ–∫—Å–∏ Nginx –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Docker –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º Ansible.

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
tree .
.
‚îú‚îÄ‚îÄ Makefile                   # –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ README.md                  # —ç—Ç–æ—Ç —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ inventory/                 # –ø–∞–ø–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
‚îÇ   ‚îî‚îÄ‚îÄ hosts                  # —Ñ–∞–π–ª —Å —Ö–æ—Å—Ç–∞–º–∏
‚îú‚îÄ‚îÄ requirements.yml           # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Ansible Collection
‚îú‚îÄ‚îÄ roles/                     # —Ä–æ–ª–∏ Ansible
‚îÇ   ‚îú‚îÄ‚îÄ common/                # –±–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ UFW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îú‚îÄ‚îÄ docker/                # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker, Compose v2 –∏ —Å–µ—Ç–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îú‚îÄ‚îÄ nginx/                 # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SSL –∏ –ø—Ä–æ–∫—Å–∏ Nginx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îú‚îÄ‚îÄ postgres/              # –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL master/replica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vars/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ docker-compose.yml.j2
‚îÇ   ‚îî‚îÄ‚îÄ wordpress/             # –¥–µ–ø–ª–æ–π WordPress —á–µ—Ä–µ–∑ Docker Compose
‚îÇ       ‚îú‚îÄ‚îÄ handlers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ       ‚îú‚îÄ‚îÄ vars/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ       ‚îú‚îÄ‚îÄ tasks/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ       ‚îî‚îÄ‚îÄ templates/
‚îÇ           ‚îú‚îÄ‚îÄ docker-compose.yml.j2
‚îÇ           ‚îî‚îÄ‚îÄ nginx.conf.j2
‚îî‚îÄ‚îÄ site.yml                   # –≥–ª–∞–≤–Ω—ã–π playbook
```

## ‚öôÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∞—è –º–∞—à–∏–Ω–∞ —Å Ansible ‚â• 2.18
* Python 3 –∏ SSH-–¥–æ—Å—Ç—É–ø –∫ —Ü–µ–ª–µ–≤—ã–º —Ö–æ—Å—Ç–∞–º
* –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `make` (—É—Ç–∏–ª–∏—Ç–∞ Make)
* –ü—Ä–∞–≤–∞ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–∞—Ö (sudo)

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞:

   ```bash
   git clone <repo-url>
   cd <repo-dir>
   ```
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ Makefile:

   ```bash
   make            # install, ping, run
   ```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
ansible-galaxy collection install -r requirements.yml
ansible-playbook -i inventory/hosts site.yml
```

## üóÇ Inventory

–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ `inventory/hosts`:

```ini
[wordpress_servers]
server1.example.com ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
```

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–¥–∞—é—Ç—Å—è –≤ `roles/*/vars/main.yml`. –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ —á–µ—Ä–µ–∑ `group_vars/all.yml` –∏–ª–∏ —Ñ–ª–∞–≥ `-e`.

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                  | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
| --------------------------- | --------------------- | ----------------------------------------- |
| `postgres_user`             | `wp_user`             | –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PostgreSQL              |
| `postgres_password`         | `secret`              | –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL            |
| `postgres_replica_user`     | `replicator`          | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏                   |
| `postgres_replica_password` | `replica_pass`        | –ü–∞—Ä–æ–ª—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏                         |
| `wordpress_db_user`         | `wp_user`             | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î –¥–ª—è WordPress             |
| `wordpress_db_password`     | `secret`              | –ü–∞—Ä–æ–ª—å –ë–î –¥–ª—è WordPress                   |
| `docker_compose_path`       | `/opt/wordpress`      | –ü—É—Ç—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å Docker Compose —Ñ–∞–π–ª–∞–º–∏ |
| `env_file_path`             | `/opt/wordpress/.env` | –ü—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è `.env`            |

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

* **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å**:

  ```bash
  make run
  ```
* **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–æ–≤**:

  ```bash
  make ping
  ```

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–µ–π

* **common**: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW, –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤ 22/80/443
* **docker**: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker, –ø–ª–∞–≥–∏–Ω–∞ Compose v2, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ `wp_net`
* **postgres**: —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL (master + replica)
* **wordpress**: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Docker Compose –¥–ª—è WordPress, –æ–∂–∏–¥–∞–Ω–∏–µ –ë–î –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
* **nginx**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è self-signed SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏

## üîÑ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–í—Å–µ –∑–∞–¥–∞—á–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã: –ø–ª–µ–π–±—É–∫ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.
