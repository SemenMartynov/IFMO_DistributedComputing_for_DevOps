# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º (ITMO / –Ø–Ω–¥–µ–∫—Å.–ü—Ä–∞–∫—Ç–∏–∫—É–º)

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–±–ª–∞—á–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Yandex Cloud. –í –ø—Ä–æ–µ–∫—Ç–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É –º–∞—Å—Ç–µ—Ä- –∏ —Å–ª–µ–π–≤-—Å–µ—Ä–≤–µ—Ä–∞–º–∏ PostgreSQL.

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: Terraform + Yandex Cloud
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: Ansible
- **–°–£–ë–î**: PostgreSQL (–º–∞—Å—Ç–µ—Ä-—Å–ª–µ–π–≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ê–∫–∫–∞—É–Ω—Ç –≤ [Yandex Cloud](https://cloud.yandex.ru/)
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π [Terraform](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli) (1.11.3)
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/index.html) (2.15.13)
- –î–æ—Å—Ç—É–ø –∫ YC CLI (`yc`)

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
–ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É infrs
```bash

cd infra
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è:
```bash

cp terraform_exp.tfvars terraform.tfvars
nano terraform.tfvars  # –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª
```

–ò–ª–∏ —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É secrets, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —Ç–∞–º
```bash
mkdir secrets
cp terraform_exp.tfvars secrets/terraform.tfvars
nano secrets/terraform.tfvars
```

### 3. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```bash

terraform init
terraform apply -auto-approve # –∏–ª–∏ terraform apply --var-file="secrets/terraform.tfvars" -auto-approve
```
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- –í `infra/secrets/vm_ips.json` –ø–æ—è–≤—è—Ç—Å—è IP-–∞–¥—Ä–µ—Å–∞ –í–ú
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è Ansible

4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Ansible
```bash

cd ansible/
ansible-playbook -i inventory.yml playbook.yml

üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
‚îú‚îÄ‚îÄ infra/                   # Terraform-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf           # –í—ã—Ö–æ–¥–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ terraform_exp.tfvars # –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ inventory.yml        # –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
‚îÇ   ‚îú‚îÄ‚îÄ playbook.yml         # –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫
‚îÇ   ‚îî‚îÄ‚îÄ roles/               # –†–æ–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ       ‚îú‚îÄ‚îÄ postgres_master/
‚îÇ       ‚îú‚îÄ‚îÄ postgres_slave/
‚îÇ       ‚îî‚îÄ‚îÄ app_server/
‚îî‚îÄ‚îÄ README.md                # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í—Å–µ sensitive-–¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω—ã, –ø–∞—Ä–æ–ª–∏) –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ .gitignore
- –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –í–ú –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ SSH-–∫–ª—é—á–∏

üìù –õ–∏—Ü–µ–Ω–∑–∏—è
MIT License. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ñ–∞–π–ª–µ LICENSE.

> **Note**
> 
> –ü—Ä–æ–µ–∫—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö —É—á–µ–±–Ω–æ–≥–æ –∫—É—Ä—Å–∞ "–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" –≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –ò–¢–ú–û –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –Ø–Ω–¥–µ–∫—Å.–ü—Ä–∞–∫—Ç–∏–∫—É–º–∞.


### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –î–æ–±–∞–≤—å—Ç–µ `.gitignore` —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º:
   ```gitignore
   *.tfstate
   *.tfvars
   secrets/
   .terraform/

2. –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Ansible inventory –¥–æ–±–∞–≤—å—Ç–µ –≤ outputs.tf:

    ``` terraform
    output "ansible_inventory" {
      value = templatefile("${path.module}/templates/inventory.tpl", {
        app_ip    = yandex_compute_instance.app.network_interface.0.ip_address,
        master_ip = yandex_compute_instance.pg_master.network_interface.0.ip_address,
        slave_ip  = yandex_compute_instance.pg_slave.network_interface.0.ip_address
      })
    }
    ```

3. –ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞ inventory.tpl:

    ```ansible
    ini
    [app]
    app_server ansible_host=${app_ip}
    
    [db_master]
    pg_master ansible_host=${master_ip}
    
    [db_slave]
    pg_slave ansible_host=${slave_ip}
    
    [all:vars]
    ansible_user=ubuntu
    ansible_ssh_private_key_file=~/.ssh/id_rsa
    ```