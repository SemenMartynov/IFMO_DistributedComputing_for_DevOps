# Лабораторная работа по Ansible

## Описание

Данная лабораторная работа демонстрирует процесс автоматической установки и настройки веб-сервиса WordPress с
использованием Ansible. В результате выполнения проекта создаётся инфраструктура, включающая базу данных MariaDB, сервер
WordPress и сервер Nginx для работы сайта.

Сайт WordPress будет доступен по адресу: **http://158.160.97.167**

---

## Минимальные требования для запуска

### Операционная система

- **Ubuntu 24.04.2 LTS**

### Конфигурация сервера:

- Процессор: 2 ядро, 2.2 ГГц
- Оперативная память: 2 ГБ
- Жёсткий диск: 40 ГБ (HDD, RAID)
- Сетевая конфигурация: 1 IP-адрес

---

## Структура проекта

Проект состоит из нескольких Ansible плейбуков, каждый из которых выполняет свою задачу:

1. **`default_settings.yml`** – Настройка операционной системы (локаль, временная зона, необходимые пакеты, обновление
   репозиториев).
2. **`install_docker.yml`** – Установка Docker Engine и связанных инструментов для контейнеризации.
3. **`install_wordpress.yml`** – Подготовка директорий, настройка Nginx, MariaDB и деплой WordPress с использованием
   Docker Compose.
4. **`setup_nginx.yml`** – Настройка и проверка конфигурации Nginx для работы с WordPress.
5. **`create_master.yml`** – Создание и настройка MariaDB Master (главной базы данных).
6. **`create_replica.yml`** – Создание реплики базы данных MariaDB и настройка репликации.
7. **`main.yml`** – Основной плейбук, объединяющий все этапы настройки через включение вышеуказанных файлов.

---

## Теги для плейбуков

Для удобства выполнения отдельных наборов задач плейбуки организованы с использованием тегов. Теги позволяют запускать
только те задачи, которые соответствуют вашим потребностям на текущий момент.

### Список доступных тегов:

- **`setup`**: Задачи, связанные с настройкой базовых параметров (например, репозитории, часовой пояс, локаль и т.д.).
- **`docker`**: Установка и настройка Docker.
- **`wordpress`**: Установка WordPress.
- **`setup_nginx`**: Настройка Nginx.
- **`create_master`**: Создание MariaDB Master.
- **`create_replica`**: Создание реплики MariaDB.

---

## Подготовка системы

Перед запуском Ansible убедитесь, что сервер соответствует минимальным требованиям, а на нём установлен Python. Для
установки используйте команду:

```bash
sudo apt update && sudo apt install -y python3 python3-pip
```

Установите `ansible` на свою локальную машину для выполнения плейбуков:

```bash
pip install ansible
```

---

## Переменные для настройки

Для удобства и гибкости настройки инфраструктуры используются следующие переменные:

### Общие переменные:

- `time_zone` — Временная зона.
- `locale1`, `locale2` — Настройки локали.

### Переменные базы данных:

- `db_root_password` — Пароль для пользователя `root` в MariaDB.
- `db_wordpress_user` — Имя пользователя для базы данных WordPress.
- `db_wordpress_password` — Пароль для пользователя базы данных WordPress.
- `wordpress_database` — Имя базы данных для WordPress.

### Переменные томов:

- `vol_nginx_www` — Путь для данных сайта (файлы WordPress).
- `vol_nginx_conf` — Путь для конфигурационных файлов Nginx.
- `vol_db_data` — Путь для данных Master-базы данных MariaDB.
- `vol_db_conf` — Путь для конфигурационных файлов Master-базы данных MariaDB.
- `vol_db_data_slave` — Путь для данных реплики базы данных MariaDB.
- `vol_db_conf_slave` — Путь для конфигурационных файлов реплики базы данных MariaDB.

---

## Порядок выполнения

**Шаг 1**: Запустите основной плейбук для выполнения полной настройки:

   ```bash
   ansible-playbook playbook.yml --ask-vault-pass
   ```

#### Действия:

- Установка необходимых пакетов (например, , ). `ca-certificates``curl`
- Настройка временной зоны.
- Настройка локали.
- Проверка наличия Docker Engine и зависимых пакетов.
- Установка Docker и плагинов.
- Создание директорий для WordPress, MariaDB и Nginx.
- Создание сети Docker и настройка конфигураций Nginx.
- Копирование файлов Docker Compose.
- Запуск Docker Compose.


#### Результат:
Будет полностью развернуто окружение:
- MariaDB.
- WordPress с базой данных на MariaDB.
- Проксирование через Nginx.

**Шаг 2**: База данных запущенная в контенере db преобразуется в master систему.

   ```bash
   ansible-playbook playbook.yml --ask-vault-password --tags create_master
   ```

#### Действия:

- Проверка наличия конфигурационного файла для мастера. `mariadb.cnf`
- Создание резервной копии конфигурационного файла.
- Настройка параметров репликации
- Перезапуск MariaDB.
- Проверка корректности настроек репликации через . `SHOW BINLOG STATUS;`
- Восстановление в случае ошибки.
- Логи выполнения.

#### Результат:

MariaDB настроен как Master-сервер, готов к работе с репликой.

**Шаг 3**: База данных запущенная в контенере db_slave подключается как slave реплика.

   ```bash
   ansible-playbook playbook.yml --ask-vault-password --tags create_replica
   ```

#### Действия:

- Создание директорий для резервных копий на стороне реплики.
- Создание резервной копии
- Проверка и настройка конфигурационного файла для реплики. `mariadb.cnf`
- Создание пользователя репликации на мастере (с правами репликации).
- Снятие дампа баз данных с мастера и его копирование на реплику.
- Восстановление дампа баз данных на реплике.
- Настройка параметров репликации в реплики. `mariadb.cnf`
- Запуск команды `CHANGE MASTER TO` для синхронизации мастера и реплики.
- Проверка состояния репликации через `SHOW SLAVE STATUS;`.

#### Результат:

MariaDB настроен как реплика с подключением к мастеру.

## Результат

После выполнения всех команд будет настроено следующее:

- MariaDB Master с базой данных для WordPress.
- MariaDB Replica для обеспечения резервирования и отказоустойчивости.
- Контейнер WordPress с готовым к использованию веб-приложением.
- Контейнер Nginx, проксирующий запросы к WordPress и обеспечивающий доступ через HTTP.
- Docker-сеть (`app_network`), соединяющая все сервисы

Сайт будет доступен по адресу: **http://45.8.230.65**

---

## Замечания

- Все плейбуки используют лицензирование (SPDX License) в формате GPL-2.0-later.
- При необходимости изменения конфигурации используйте соответствующие переменные.

---

## Автор

Spartak Katvitskii  
DevOps, ITMO