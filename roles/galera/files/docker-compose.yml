services:
  {{ db_host }}:
    image: bitnami/mariadb-galera:latest
    restart: always
    ports:
      - 3308:3306
    volumes:
      - {{ db_host }}_data:/bitnami/mariadb
    environment:
      MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
      MARIADB_GALERA_MARIABACKUP_USER: ${MARIADB_GALERA_MARIABACKUP_USER}
      MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: 'yes'
      MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: 'yes'
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_REPLICATION_USER: ${MARIADB_REPLICATION_USER}
      MARIADB_REPLICATION_PASSWORD: ${MARIADB_REPLICATION_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin -uroot -p$$MARIADB_ROOT_PASSWORD ping -h localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  {{ db2_host }}:
    depends_on:
      {{ db_host }}:
        condition: service_healthy
    image: bitnami/mariadb-galera:latest
    restart: always
    volumes:
      - {{ db2_host }}_data:/bitnami/mariadb
    environment:
      MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
      MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://{{ db_host }}:4567,0.0.0.0:4567
      MARIADB_GALERA_MARIABACKUP_USER: ${MARIADB_GALERA_MARIABACKUP_USER}
      MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MARIADB_REPLICATION_USER: ${MARIADB_REPLICATION_USER}
      MARIADB_REPLICATION_PASSWORD: ${MARIADB_REPLICATION_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin -uroot -p$$MARIADB_ROOT_PASSWORD ping -h localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  {{ db3_host }}:
    depends_on:
      {{ db_host }}:
        condition: service_healthy
      {{ db2_host }}:
        condition: service_healthy
    image: bitnami/mariadb-galera:latest
    restart: always
    volumes:
      - {{ db3_host }}_data:/bitnami/mariadb
    environment:
      MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
      MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://{{ db_host }}:4567,0.0.0.0:4567
      MARIADB_GALERA_MARIABACKUP_USER: ${MARIADB_GALERA_MARIABACKUP_USER}
      MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MARIADB_REPLICATION_USER: ${MARIADB_REPLICATION_USER}
      MARIADB_REPLICATION_PASSWORD: ${MARIADB_REPLICATION_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin -uroot -p$$MARIADB_ROOT_PASSWORD ping -h localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  {{ db4_host }}:
    depends_on:
      {{ db_host }}:
        condition: service_healthy
      {{ db2_host }}:
        condition: service_healthy
      {{ db3_host }}:
        condition: service_healthy
    image: bitnami/mariadb-galera:latest
    restart: always
    volumes:
      - {{ db4_host }}_data:/bitnami/mariadb
    environment:
      MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
      MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://{{ db_host }}:4567,0.0.0.0:4567
      MARIADB_GALERA_MARIABACKUP_USER: ${MARIADB_GALERA_MARIABACKUP_USER}
      MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MARIADB_REPLICATION_USER: ${MARIADB_REPLICATION_USER}
      MARIADB_REPLICATION_PASSWORD: ${MARIADB_REPLICATION_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin -uroot -p$$MARIADB_ROOT_PASSWORD ping -h localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  {{ db5_host }}:
    depends_on:
      {{ db_host }}:
        condition: service_healthy
      {{ db2_host }}:
        condition: service_healthy
      {{ db3_host }}:
        condition: service_healthy
      {{ db4_host }}:
        condition: service_healthy
    image: bitnami/mariadb-galera:latest
    restart: always
    volumes:
      - {{ db5_host }}_data:/bitnami/mariadb
    environment:
      MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
      MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://{{ db_host }}:4567,0.0.0.0:4567
      MARIADB_GALERA_MARIABACKUP_USER: ${MARIADB_GALERA_MARIABACKUP_USER}
      MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MARIADB_REPLICATION_USER: ${MARIADB_REPLICATION_USER}
      MARIADB_REPLICATION_PASSWORD: ${MARIADB_REPLICATION_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin -uroot -p$$MARIADB_ROOT_PASSWORD ping -h localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  {{ loadbalancer }}:
    depends_on:
      {{ db_host }}:
        condition: service_healthy
      {{ db2_host }}:
        condition: service_healthy
      {{ db3_host }}:
        condition: service_healthy
      {{ db4_host }}:
        condition: service_healthy
      {{ db5_host }}:
        condition: service_healthy
    image: haproxy:3.1
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - 3306:3306
      - 8404:8404
    sysctls:
      net.ipv4.ip_unprivileged_port_start: 0
  wordpress:
    depends_on:
      {{ loadbalancer }}:
        condition: service_started
    image: wordpress:latest
    volumes:
      - wp_data:/var/www/html
    ports:
      - {{ wordpress_port }}:80
    restart: always
    environment:
      WORDPRESS_DB_HOST: ${DB_HOST}
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: ${DB_NAME}

volumes:
  wp_data:
  {{ db_host }}_data:
  {{ db2_host }}_data:
  {{ db3_host }}_data:
  {{ db4_host }}_data:
  {{ db5_host }}_data: