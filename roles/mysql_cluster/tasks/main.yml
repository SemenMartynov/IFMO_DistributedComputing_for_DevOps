---
# Задачи для настройки кластера MySQL

- name: Проверка наличия Docker и Docker Compose
  command: docker compose version
  register: docker_compose_check
  failed_when: false
  changed_when: false

- name: Создание директории для проекта WordPress MySQL Cluster
  file:
    path: "{{ mysql_cluster_dir }}"
    state: directory
    mode: '0755'

- name: Создание директорий для данных каждой ноды кластера
  file:
    path: "{{ mysql_cluster_dir }}/mysql_data_{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ range(1, mysql_cluster_nodes + 1) | list }}"

- name: Копирование .env файла для кластера
  template:
    src: mysql_cluster/.env.j2
    dest: "{{ mysql_cluster_dir }}/.env"
    mode: '0644'

- name: Копирование docker-compose.yml
  template:
    src: mysql_cluster/docker-compose.yml.j2
    dest: "{{ mysql_cluster_dir }}/docker-compose.yml"
    mode: '0644'

- name: Копирование init-primary.sql
  template:
    src: mysql_cluster/init-primary.sql.j2
    dest: "{{ mysql_cluster_dir }}/init-primary.sql"
    mode: '0644'

- name: Установка Python-модуля pymysql для community.mysql.mysql_replication
  apt:
    name: python3-pymysql
    state: present
  become: true

- name: Создание сети Docker для кластера MySQL
  docker_network:
    name: "{{ wp_mysql_cluster_name }}"
    driver: bridge
    state: present

- name: Остановка старых контейнеров
  community.docker.docker_compose_v2:
    project_src: "/opt/wordpress/"
    state: absent

- name: Запуск контейнеров кластера через Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ mysql_cluster_dir }}/"
    state: present

- name: Проверка доступности MySQL
  shell: docker exec mysql_node_1 mysqladmin ping -uroot -p{{ mysql_root_password }} --silent
  register: result
  retries: 10
  delay: 60
  until: result.rc == 0

- name: Выборка информации о бинарном логе
  shell: |
    docker exec mysql_node_1 mysql -uroot -p"{{ mysql_root_password }}" \
      -e "SHOW MASTER STATUS\G" | grep "File\|Position" | awk '{print $2}'
  register: log_info
  changed_when: false
  failed_when: false

- name: Получение имени файла и позиции
  set_fact:
    master_log_file: "{{ log_info.stdout_lines[0] }}"
    master_log_pos: "{{ log_info.stdout_lines[1] }}"

- name: Вывод информации о параметрах репликации
  debug:
    msg: "Log File: {{ master_log_file }}, Position: {{ master_log_pos }}"

- name: Остановка репликации на вторичных узлах перед настройкой
  community.mysql.mysql_replication:
    mode: stopreplica
    login_host: localhost
    login_port: "{{ 3307 + item - 2 }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
  loop: "{{ range(2, mysql_cluster_nodes + 1) | list }}"
  ignore_errors: true

- name: Настройка репликации на вторичных узлах
  community.mysql.mysql_replication:
    mode: changeprimary
    primary_host: mysql_node_1
    primary_port: 3306
    primary_user: "{{ repl_user }}"
    primary_password: "{{ repl_password }}"
    primary_log_file: "{{ master_log_file }}"
    primary_log_pos: "{{ master_log_pos }}"
    login_host: localhost
    login_port: "{{ 3307 + item - 2 }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
  loop: "{{ range(2, mysql_cluster_nodes + 1) | list }}"

- name: Запуск репликации на вторичных узлах
  community.mysql.mysql_replication:
    mode: startreplica
    login_host: localhost
    login_port: "{{ 3307 + item - 2 }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
  loop: "{{ range(2, mysql_cluster_nodes + 1) | list }}"

- name: Проверка статуса репликации на вторичных узлах
  community.mysql.mysql_replication:
    mode: getreplica
    login_host: localhost
    login_port: "{{ 3307 + item - 2 }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
  register: replica_status
  loop: "{{ range(2, mysql_cluster_nodes + 1) | list }}"

- name: Вывести статус репликации
  debug:
    msg: "{{ replica_status }}"