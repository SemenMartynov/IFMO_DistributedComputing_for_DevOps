---
- name: Create directories
  ansible.builtin.file:
    path: "{{ monitoring_dir }}/common"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Generate a 2048-bit RSA private key
  community.crypto.openssl_privatekey:
    path: "{{ monitoring_dir }}/common/exporter.key"
    size: 2048
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Generate an OpenSSL Certificate Signing Request
  community.crypto.openssl_csr:
    path: "{{ monitoring_dir }}/common/exporter.csr"
    privatekey_path: "{{ monitoring_dir }}/common/exporter.key"
    common_name: "{{ certificate_common_name }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Generate a Self Signed OpenSSL certificate
  community.crypto.x509_certificate:
    path: "{{ monitoring_dir }}/common/exporter.crt"
    privatekey_path: "{{ monitoring_dir }}/common/exporter.key"
    csr_path: "{{ monitoring_dir }}/common/exporter.csr"
    provider: selfsigned
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Encrypt password
  ansible.builtin.set_fact:
    monitoring_password_encrypted: "{{ monitoring_password | password_hash('bcrypt') }}"

- name: Creating web config file
  ansible.builtin.copy:
    dest: "{{ monitoring_dir }}/common/config.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    content: |
      tls_server_config:
        cert_file: exporter.crt
        key_file: exporter.key
      basic_auth_users:
        {{ monitoring_user }}: {{ monitoring_password_encrypted }}
