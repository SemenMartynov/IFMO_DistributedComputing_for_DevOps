---
- name: Home work 1
  hosts: carrier
  tasks:
    - name: Install Docker Engine on Ubuntu
      become: true
      block:
        - name: Install required packages
          ansible.builtin.apt:
            name:
              - ca-certificates=20240203
              - curl=8.5.0-2ubuntu10.6
            state: present
            update_cache: true

        - name: Add Docker's official GPG key
          ansible.builtin.apt_key:
            state: present
            url: https://download.docker.com/linux/ubuntu/gpg

        - name: Add the repository to Apt sources
          ansible.builtin.apt_repository:
            repo: deb https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
            state: present

        - name: Install the Docker packages
          ansible.builtin.apt:
            name:
              - containerd.io=1.7.26-1
              - docker-ce=5:28.0.4-1~ubuntu.24.04~noble
              - docker-ce-cli=5:28.0.4-1~ubuntu.24.04~noble
              - docker-buildx-plugin=0.22.0-1~ubuntu.24.04~noble
              - docker-compose-plugin=2.34.0-1~ubuntu.24.04~noble
            state: present
            update_cache: true

        - name: Add user to the docker group
          ansible.builtin.user:
            append: true
            groups: docker
            name: "{{ ansible_env.USER }}"

    - name: Deploy WordPress with Docker Compose
      block:
        - name: Reset ssh connection to allow user changes to affect
          ansible.builtin.meta: reset_connection

        - name: Create webapp directory
          ansible.builtin.file:
            mode: "0755"
            path: webapp
            state: directory

        - name: Copy webapp/docker-compose.yml
          ansible.builtin.copy:
            dest: webapp/docker-compose.yml
            mode: "0644"
            content: |
              services:
                db:
                  environment:
                    MYSQL_DATABASE: {{ wordpress_db_name }}
                    MYSQL_USER: {{ db_user }}
                    MYSQL_PASSWORD: {{ db_user_pass }}
                    MYSQL_ROOT_PASSWORD: {{ db_pass }}
                  healthcheck:
                    interval: 10s
                    retries: 20
                    start_period: 1m
                    test: ["CMD-SHELL", "mysql -p$$MYSQL_ROOT_PASSWORD -e 'SELECT 1'"]
                  image: mysql:8.0.41-bookworm
                  restart: unless-stopped
                  volumes:
                    - db:/var/lib/mysql

                wordpress:
                  environment:
                    WORDPRESS_DB_HOST: {{ db_host }}
                    WORDPRESS_DB_USER: {{ db_user }}
                    WORDPRESS_DB_PASSWORD: {{ db_user_pass }}
                    WORDPRESS_DB_NAME: {{ wordpress_db_name }}
                  image: wordpress:6.8.0-php8.4-apache
                  ports:
                    - {{ wordpress_port }}:80
                  restart: unless-stopped
                  volumes:
                    - wordpress:/var/www/html

              volumes:
                db:
                wordpress:

        - name: Create and start services
          community.docker.docker_compose_v2:
            project_src: webapp
            wait: true

    - name: Display Configuration Variables
      ansible.builtin.debug:
        msg:
          - "wordpress: {{ is_wordpress }}" # True or False
          - "wordpress_port: {{ wordpress_port }}" # 80 or 8080 or whatewer
          - "wordpress_db_name: {{ wordpress_db_name }}" # WP database name
          - "db_host: {{ db_host }}" # container name
          - "db_pass: {{ db_pass }}" # root password
